---
- name: Setup Jenkins server
  hosts: all
  become: true
  remote_user: ubuntu

  vars:
    jenkins_lts_version: "2.440.1"
    #vaultpass: 1
    private_key: !vault |
                  $ANSIBLE_VAULT;1.1;AES256
                  36333933333037393538316164306634313835383434653435633663636433393534363964343236
                  3939656439623535353065323430633135353065373437610a623030616362656561303965616265
                  64396132343866373132366134613638336561353137383864316363646130633833353163643138
                  6637633036323330390a393337386266346562373134316465303166353939656664303635386238
                  66653639626233643234633162376438316363613034613766643564636330376635653862666163
                  65626534373565373938653566653037636264316336316262386435626236353732333631323331
                  37663464363039303766363662326464386638636663623736343135346138616233373766386635
                  62646334336161626233383762653333303039613363313762333038623938666135323738613631
                  66346636383138313634366639636539636336663038303532326137613762376137386531363465
                  34663661306134353232626230363737353061316635613830633636323230396430306331356136
                  32653734656264333330353636313337396263393839666137366132373038663136336433323763
                  39643036333232616139356262356537336137623238306533306361656665333239323435643565
                  37653033656461336139346535633237636664313261336337376166626238663836313664383133
                  66386564343433356334353462613961373066356664666435633831623461633930333437663739
                  35373563623832313235616565303961613763393038396662386439336631323133636632333861
                  33363334396339356564616439613631333931373432316230653138373231383936663062633264
                  62376362666231303333346464333435343164643464616431383239663636613134396137303563
                  32643765346435333166373361633364383231613365343265623462666238333035363238333230
                  66623736613434343965373633626462623363646135343739633334633833616532343031653265
                  61376462623863323737316337643138613234653635303835653162333537626133393735326232
                  30663236353439326332393136313961663437356538346462303861386562326136376531306666
                  61353764633231633865646338666662353431393037623934333730376230303663656664376333
                  34363430356433383230636238373834353135306530316432343365316435336439353261383133
                  64363339626239623630623661313935396661393065643739336263363661656266353437653162
                  35333463393235663331616436666364616335663133623339646130613962313638666437363965
                  66656166393231623161623035376439373261376333663735366130373561383133393165666430
                  34646633306265383636393034353132656162363065353130366662656139383464623030656165
                  61636562616531303234343139346565343661623834373132386531653132376661376566636166
                  66613763383362613238343666393665653566616632666532636162626332396662323433303535
                  39303934353866396662336537613136616235623263386464616666646339363963386261363165
                  31363231633864633162393239623935616238653331663138343065636263633030656135646235
                  36623436613837383063373032666661363563383637633136303662383666643130656563366162
                  36373962386133343339623439616439376635323930303735303138396564376164663438613937
                  65396665386666633130383166613730343134393733663732343533633461643037336163643033
                  64303033663938663232356231643339333464663561373633323663333964636664363032336339
                  37633439343437343334323534653435373964653666623437653531653339376138636462653233
                  66333936393531373835626638363035353565336433343930633934626432303436393266646665
                  62396363316464346261663138633933323532613831633133626164336233663562306430383766
                  39646339333730326637356162353632313333663130386138313130646238346565383637356334
                  39666339303138366664383634393463393739636235633939353533373131636566373163313434
                  39383630333736626234333961613763653262626663386137663565353166323133646439303865
                  63363761323862613537393938663832626337383533643565633665656433643031396334383264
                  35636263663265323239623532343464333336636263376462393838666264623864343866636332
                  32343963386330313566323230366163383762623562646166383034643761636138393761346430
                  63666631326364333732323531336130636636366239636566633338343865363862316637643836
                  34373332646239393134633361373239646664393631363563633236656639323238663561353832
                  35353963666365396135386564316162333130366531326638636239343339313131393238303831
                  38323033383536613236626266323235363334333363663331383033363030626137383233616132
                  35663564303234313361313536613839326162363261373536396131616532313436316366626632
                  62363639313930346163633763356437646439396665396438666136353766376535393061396363
                  36653262623964383161643566343531313665636138643863356436333635633538636666393263
                  64333139306438666261653962343633613764633361306161613836363436323664326665366362
                  62653033383162353631356135336635343033623738303566353865323439633762306631303733
                  33333862623966356432323934323233616132326336623637313962636565313661666166633735
                  31653066626537313439653164666561336535653635613765386437376333613933393261346537
                  37356532323464633963393361663633363732633237313737663233306538396630346435323437
                  39666566623938633938323638376139363062356132376433313931613437613731663838353935
                  62643362633366383366613530656463363633333464643738646435383861386533333838363433
                  65626531363362333437356231656361346466383535323132376636323338613535353133393861
                  39363230613435666162303636303131383264313766333961373833616332373364323665393039
                  63386134353363353731323733613031393538353764316532323664346266373964383038326166
                  32613638653739393363653439636531396463393962313839646461343338376265373238613536
                  64653466343563653833306530343436323066353634373264316136616231323430666661636566
                  36356461666265666331663061653765643438393034313433313465653664316239613932323132
                  64643862356439646337663536383538633564313663353866363734393664333061346430383631
                  32623465346466626666393932363831306239393264386631386339393162626363656564333235
                  65666130626230326364383965623763316330373032393962383634633830383939613233646233
                  66393138353761396664336238633636633165383762313934396431643332663734636463633864
                  61326661393838613866343832346131303637633761313933366130383266316462366234343538
                  62373134646439653532343735636238383839626465363330616135623935633435343433333333
                  65386332393963373965323738653064336339316530613761623662363166356362323032653434
                  38373932623564313732663732336138306465626634333964396437653530363934363764396335
                  62616535633636343730323633666239653031306134336664346231306430653234386532336663
                  30303537666337663232356636336236363332353731326133316664303132373038656439393861
                  33376665396635303935353337323164326439653332326566616366316438613762633063666665
                  34326564353735353730663235373036303863613134626532306636663739323239363164386431
                  39316164653339303233363433303935663139323064353531376338396438643438666235366436
                  37623862626339656163626435653163353939346630633964346264306430313666376563346338
                  39663762353335323535626630396433386233383639343433343465326463343762353164626136
                  66613334643536616636323131366365303462313033623464663432643130666365383264313936
                  37333434333437656336366561383562613934396366653661643562386337333736656162323566
                  37613231616130303366366564623861303131653230366139333135346361396166306266363462
                  35376365666336633333616330336162316339383538333530383366383739346333666663663637
                  38303065363862336539623964343133653032653539396365346663313838353537643130336462
                  36353033316334666131363162376263616463393764646634393562353235656463396132363361
                  36373038373637626362613031333663653832646437313134376132316264623665646562363461
                  64643564383639303736643933366434373631653865353965383162356564326430666332353737
                  38323636333333363631

  pre_tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

  roles:
    - archive
    - pip3
    - boto3
    - java
    - nfs
    - aws-cli
    - jenkins
    - docker

  tasks:
    - name: Configuring Jenkins
      block:
        - name: Create SSH directory for user jenkins
          file:
            path: /var/lib/jenkins/.ssh
            mode: 0700
            owner: jenkins
            group: jenkins
            state: directory

        - name: Add private key for user jenkins
          lineinfile:
            path: /var/lib/jenkins/.ssh/id_rsa
            line: '{{ private_key }}'
            owner: jenkins
            group: jenkins
            mode: 0400
            create: true

        - name: Install Apache2
          apt:
            name: apache2
            state: present

        - name: Enable Apache2 proxy mod
          apache2_module:
            name: proxy
            state: present

        - name: Restart Apache2 service
          systemd:
            name: apache2
            state: restarted

        - name: Add jenkins site config to Apache2
          template:
            src: templates/jenkins.conf.j2
            dest: /etc/apache2/sites-enabled/jenkins.conf
            owner: root
            group: root
            mode: '0644'

        - name: Restart Apache2 service
          systemd:
            name: apache2
            state: restarted
    
    - name: Configuring Docker
      block:
        - name: Change ExecStart variable
          lineinfile:
            path: /lib/systemd/system/docker.service
            regexp: '^ExecStart='
            line: ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock
    
        - name: Restart Docker service
          systemd:
            name: docker
            state: restarted
            daemon_reload: true